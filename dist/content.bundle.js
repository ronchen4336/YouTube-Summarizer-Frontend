(()=>{const e=window.browser||window.chrome,t="yt-summarizer-btn",n="yt-persistent-summary-panel";function o(){if(document.getElementById(t))return;const e=document.createElement("button");e.id=t,e.className="yt-summarizer-button",e.title="Generate Video Summary";const n=document.createElement("span");n.className="yt-summarizer-icon",n.textContent="✨";const o=document.createElement("span");o.className="yt-summarizer-text",o.textContent="Summarize",e.appendChild(n),e.appendChild(o),e.addEventListener("click",c);const r=document.createElement("div");r.className="yt-summarizer-container",r.appendChild(e);const a=document.querySelector(".ytp-right-controls");a&&(a.insertBefore(r,a.firstChild),console.log("Summary button added to YouTube player controls"))}function r(){const e=document.getElementById(n);e&&e.remove();const t=document.createElement("div");t.id=n,t.className="yt-summarizer-panel persistent-panel";const o=document.createElement("div");o.className="yt-summarizer-panel-header";const r=document.createElement("h2");r.textContent="Video Summary";const a=document.createElement("div");a.className="yt-summarizer-controls";const s=document.createElement("button");s.className="yt-summarizer-minimize",s.innerHTML="_",s.title="Minimize";const c=document.createElement("button");c.className="yt-summarizer-close",c.innerHTML="×",c.title="Close",a.appendChild(s),a.appendChild(c),o.appendChild(r),o.appendChild(a);const i=document.createElement("div");return i.className="yt-summarizer-panel-content",s.addEventListener("click",(()=>{t.classList.toggle("minimized"),t.classList.contains("minimized")?(s.innerHTML="□",s.title="Restore"):(s.innerHTML="_",s.title="Minimize")})),c.addEventListener("click",(()=>{t.remove()})),t.appendChild(o),t.appendChild(i),document.body.appendChild(t),t}function a(t){try{console.log("Displaying persistent summary:",t);let e=document.getElementById(n);e||(e=r());const o=e.querySelector(".yt-summarizer-panel-content");if(!o)return void console.error("Panel content area not found");let a;if(t.response)try{a=JSON.parse(t.response)}catch(e){throw console.error("Error parsing response:",e),new Error("Invalid response format")}else{if("object"!=typeof t||!t.title||!t.body)throw new Error("Unrecognized response format");a=t}o.innerHTML="";const s=document.createElement("div");s.className="summary-title",s.textContent=a.title,o.appendChild(s),a.body.sort(((e,t)=>(e.metadata?.priority||999)-(t.metadata?.priority||999))).forEach((e=>{const t=document.createElement("div");t.className="summary-section",e.metadata?.content_type&&t.classList.add(`content-${e.metadata.content_type}`),t.setAttribute("data-section-type",e.metadata?.content_type||"general");const n=document.createElement("h3");n.textContent=e.subtitle,t.appendChild(n);const r=document.createElement("div");switch(r.className="section-content",e.metadata?.display_hint){case"highlight":r.className="highlight",r.textContent=Array.isArray(e.body_content)?e.body_content[0]:e.body_content;break;case"bullet_list":const t=document.createElement("ul");t.className="bullet-list",e.body_content.forEach((e=>{const n=document.createElement("li");n.textContent=e,t.appendChild(n)})),r.appendChild(t);break;case"tag_cloud":r.className="tag-cloud",e.body_content.forEach((e=>{const t=document.createElement("span");t.className="tag",t.textContent=e,r.appendChild(t)}));break;case"blockquote":e.body_content.forEach((e=>{const t=document.createElement("blockquote");t.className="blockquote",t.textContent=e,r.appendChild(t)}));break;case"italic_text":const n=document.createElement("ul");n.className="bullet-list",e.body_content.forEach((e=>{const t=document.createElement("li");t.style.fontStyle="italic",t.textContent=e,n.appendChild(t)})),r.appendChild(n);break;default:r.className="paragraph",Array.isArray(e.body_content)?e.body_content.forEach((e=>{const t=document.createElement("p");t.textContent=e,r.appendChild(t)})):r.textContent=e.body_content}t.appendChild(r),o.appendChild(t)}))}catch(o){console.error("Error displaying persistent summary:",o),console.error("Summary data:",t);const r=document.getElementById(n);if(r){const e=r.querySelector(".yt-summarizer-panel-content");e&&(e.innerHTML=`\n                    <div class="error-message">\n                        <p>❌ Error displaying summary: ${o.message}</p>\n                    </div>\n                `)}e.runtime.sendMessage({action:"log_error",error:`Display error: ${o.message}`})}}function s(){console.log("Initializing YouTube Summarizer extension"),i(window.location.href)?(console.log("YouTube video detected, adding summarize button"),document.querySelector(".ytp-right-controls")?o():(console.log("YouTube player controls not found, waiting..."),setTimeout(o,2e3))):console.log("Not a YouTube video page, skipping button creation")}async function c(){try{console.log("Summarize button clicked");const t=window.location.href;if(!i(t))return void alert("This button only works on YouTube video pages");let o=document.getElementById(n);o=o||r(),o.querySelector(".yt-summarizer-panel-content").innerHTML='\n            <div class="loading-container">\n                <div class="spinner"></div>\n                <p>Processing video...</p>\n            </div>\n        ';const s=await e.runtime.sendMessage({action:"getYouTubeVideo",videoUrl:t});if(!s.success)throw new Error(s.error||"Failed to process video");a(s.data)}catch(t){console.error("Error in summarize process:",t);const o=document.getElementById(n);if(o){const e=o.querySelector(".yt-summarizer-panel-content");e&&(e.innerHTML=`\n                    <div class="error-message">\n                        <p>❌ Error: ${t.message}</p>\n                        <p>Please try again later.</p>\n                    </div>\n                `)}e.runtime.sendMessage({action:"log_error",error:`Summarize error: ${t.message}`})}}function i(e){return/^(https?:\/\/)?(www\.)?(youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})(&.*)?$/.test(e)}e.runtime.onMessage.addListener(((e,t,n)=>"display_persistent_summary"===e.action?(console.log("Received request to display persistent summary"),e.summaryData?(a(e.summaryData),n({success:!0})):(console.error("No summary data received"),n({success:!1,error:"No summary data received"})),!0):"trigger_summarize"===e.action?(console.log("Received request to trigger summarization"),c(),n({success:!0}),!0):void 0)),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",s):s()})();